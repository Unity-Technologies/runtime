name: Build and Test Windows x86

agent:
  type: Unity::VM
  image: platform-foundation/windows-vs2019-il2cpp-bokken:latest
  flavor: b1.xlarge

commands:
  - |
    cd unity\unitygc
    cmake . -A Win32
    cmake --build . --config Release
  - build.cmd -subset clr+libs -a x86 -c release -ci
  - copy unity\unitygc\Release\unitygc.dll artifacts\bin\microsoft.netcore.app.runtime.win-x86\Release\runtimes\win-x86\native 
  - powershell .yamato\scripts\download_7z.ps1
  - artifacts\7za-win-x64\7za.exe a artifacts\unity\dotnet-runtime-unity-win-x86.7z .\artifacts\bin\microsoft.netcore.app.runtime.win-x86\Release\runtimes\win-x86
# build/run tests
  - build.cmd libs.tests -test -a x86 -c release -ci
  - src\tests\build.cmd x86 release ci
  - src\tests\run.cmd x86 release

triggers:
  pull_requests:
    - targets:
        only:
          - "unity-main"

artifacts: 
  win64:
    paths:
      - artifacts\unity\dotnet-runtime-unity-win-x86.7z
