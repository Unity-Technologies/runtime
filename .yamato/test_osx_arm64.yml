{% metadata_file .yamato/Globals.metafile %}
---
name: Test OSX ARM64

agent:
  type: Unity::VM::osx
  image: platform-foundation/mac-bokken:v0.1.8-972754
  flavor: m1.mac

dependencies:
  - path: .yamato/build_osx_arm64.yml

commands:
# build/run tests
  - dotnet build unity/managed.sln -c Release
  - |
    cd unity/embed_api_tests
    cmake -DCMAKE_BUILD_TYPE=Release .
    cmake --build .
    ./mono_test_app
  - LD_LIBRARY_PATH=/usr/local/opt/openssl/lib ./build.sh -subset libs.tests -test /p:RunSmokeTestsOnly=true -a arm64 -c release -ci -ninja
  - ./src/tests/build.sh arm64 release ci -tree:GC -tree:JIT -tree:baseservices -tree:interop -tree:reflection
  - ./src/tests/run.sh arm64 release
  - ./build.sh clr.paltests
  - ./artifacts/bin/coreclr/OSX.arm64.Debug/paltests/runpaltests.sh $(pwd)/artifacts/bin/coreclr/OSX.arm64.Debug/paltests

## Don't run OSX ARM64 tests for PRs until we have hardware to actually run it
# triggers:
#   pull_requests:
#     - targets:
#         only:
#           - "unity-main"
